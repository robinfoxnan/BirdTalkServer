在 Redis 中利用地理位置信息实现范围查找，主要依赖其内置的 **GEO 数据类型**和相关命令。Redis GEO 专门用于存储经纬度坐标，并支持基于地理位置的距离计算、范围筛选等操作。以下是具体实现步骤：


### 一、核心原理
Redis GEO 的底层通过 **有序集合（Sorted Set）** 实现，将经纬度通过 **GeoHash 算法**编码为一个 64 位整数（score），从而将二维坐标映射到一维空间，便于范围查询。


### 二、基本命令
#### 1. 添加地理位置（`GEOADD`）
将一个或多个地理位置（名称、经度、纬度）添加到指定的 GEO 集合中。  
**语法**：  
```bash
GEOADD key longitude latitude member [longitude latitude member ...]
```
**示例**：  
添加几个城市的坐标到 `cities` 集合：  
```bash
GEOADD cities 116.403874 39.914885 "北京"
GEOADD cities 121.473701 31.230416 "上海"
GEOADD cities 113.264385 23.129113 "广州"
GEOADD cities 114.057865 22.543096 "深圳"
```


#### 2. 计算两点距离（`GEODIST`）
计算两个地理位置之间的直线距离，支持多种单位（m 米、km 千米、mi 英里、ft 英尺）。  
**语法**：  
```bash
GEODIST key member1 member2 [unit]
```
**示例**：  
计算北京到上海的距离（单位：千米）：  
```bash
GEODIST cities 北京 上海 km  # 输出：1318.3861
```


#### 3. 范围查找（核心操作）
##### （1）基于坐标的范围查找（`GEORADIUS`）
以指定经纬度为中心，查找指定半径范围内的地理位置。  
**语法**：  
```bash
GEORADIUS key longitude latitude radius m|km|mi|ft [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC]
```
**参数说明**：  
- `WITHCOORD`：返回结果包含经纬度。  
- `WITHDIST`：返回结果包含与中心点的距离。  
- `COUNT count`：限制返回结果数量（如 `COUNT 10` 最多返回10条）。  
- `ASC|DESC`：按距离升序/降序排列（默认升序）。  

**示例**：  
查找以北京（116.403874, 39.914885）为中心，半径 1000 千米内的城市：  
```bash
GEORADIUS cities 116.403874 39.914885 1000 km WITHDIST WITHCOORD COUNT 10
```
返回结果格式：  
```
1) 1) "北京"
   2) "0.0000"  # 距离（千米）
   3) 1) "116.403874"
      2) "39.914885"
2) 1) "天津"  # 假设已添加天津坐标
   2) "120.0000"
   3) 1) "117.200000"
      2) "39.130000"
```


##### （2）基于成员的范围查找（`GEORADIUSBYMEMBER`）
以集合中某个已有成员为中心，查找指定半径范围内的地理位置（无需手动输入经纬度）。  
**语法**：  
```bash
GEORADIUSBYMEMBER key member radius m|km|mi|ft [WITHCOORD] [WITHDIST] [COUNT count] [ASC|DESC]
```
**示例**：  
查找以上海为中心，半径 2000 千米内的城市：  
```bash
GEORADIUSBYMEMBER cities 上海 2000 km WITHDIST COUNT 5
```


#### 4. 获取成员坐标（`GEOPOS`）
查询一个或多个成员的经纬度。  
**语法**：  
```bash
GEOPOS key member [member ...]
```
**示例**：  
```bash
GEOPOS cities 广州 深圳  # 返回两个城市的经纬度数组
```


#### 5. 删除成员（`ZREM`）
GEO 本身没有删除命令，需借助有序集合的 `ZREM` 命令删除成员（因为 GEO 底层是有序集合）。  
**语法**：  
```bash
ZREM key member [member ...]
```
**示例**：  
删除集合中的“深圳”：  
```bash
ZREM cities 深圳
```


### 三、实际应用场景
1. **附近的人/店**：以当前用户坐标为中心，查找半径 5 公里内的商家。  
2. **区域筛选**：筛选某个城市（如北京）周边 100 公里内的所有设施。  
3. **距离排序**：按距离用户由近到远展示周边服务。  


### 四、注意事项
1. **精度限制**：Redis GEO 使用 52 位精度的 GeoHash 编码，误差约为 1 米，满足大多数场景需求。  
2. **性能**：范围查询的时间复杂度为 O(log N + K)（N 为集合大小，K 为返回结果数），建议通过 `COUNT` 限制返回数量以提高性能。  
3. **批量操作**：`GEOADD` 支持批量添加，减少网络往返。  
4. **坐标合法性**：经度范围为 [-180, 180]，纬度范围为 [-85.05112878, 85.05112878]，超出范围会报错。  


### 五、代码示例（Go 语言）
使用 `go-redis` 客户端操作 Redis GEO：  
```go
package main

import (
	"context"
	"fmt"

	"github.com/go-redis/redis/v8"
)

func main() {
	// 连接 Redis
	rdb := redis.NewClient(&redis.Options{
		Addr: "localhost:6379",
	})
	ctx := context.Background()

	// 1. 添加地理位置
	added, err := rdb.GeoAdd(ctx, "cities", &redis.GeoLocation{
		Name:      "北京",
		Longitude: 116.403874,
		Latitude:  39.914885,
	}, &redis.GeoLocation{
		Name:      "上海",
		Longitude: 121.473701,
		Latitude:  31.230416,
	}).Result()
	if err != nil {
		panic(err)
	}
	fmt.Printf("添加了 %d 个地理位置\n", added)

	// 2. 范围查找（北京为中心，1000km内）
	result, err := rdb.GeoRadius(ctx, "cities", 116.403874, 39.914885, &redis.GeoRadiusQuery{
		Radius: 1000,
		Unit:   "km",
		WithDist: true,  // 返回距离
		WithCoord: true, // 返回坐标
		Count:   10,     // 最多返回10条
	}).Result()
	if err != nil {
		panic(err)
	}

	// 打印结果
	for _, loc := range result {
		fmt.Printf("城市：%s，距离：%.2fkm，坐标：(%.6f, %.6f)\n",
			loc.Name, loc.Dist, loc.Longitude, loc.Latitude)
	}
}
```


通过以上方法，即可利用 Redis 高效实现基于地理位置的范围查找功能，适用于各类 LBS（Location-Based Service）场景。