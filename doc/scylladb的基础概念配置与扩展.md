#  ä¸€ã€ScyllaDB çš„æ°´å¹³æ‰©å±•ç‰¹æ€§

- **åˆ†å¸ƒå¼è®¾è®¡**ï¼šæ•°æ®æŒ‰ **åˆ†åŒºé”®ï¼ˆPartition Keyï¼‰** å“ˆå¸Œåˆ° **Token Ring** ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€ä¸ª token èŒƒå›´ã€‚
- **èŠ‚ç‚¹å¢åŠ /å‡å°‘**ï¼š
  - ä¼šè‡ªåŠ¨é‡æ–°åˆ†é… token èŒƒå›´
  - æ•°æ®åœ¨èŠ‚ç‚¹é—´é‡æ–°åˆ†å¸ƒï¼ˆç§°ä¸º **rebalancing / streaming**ï¼‰
- **æ— ä¸­å¿ƒèŠ‚ç‚¹**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¯¹ç­‰ï¼Œæ— å•ç‚¹ç“¶é¢ˆ

------

## 2ï¸âƒ£ æ‰©å®¹ç±»å‹

1. **å¢åŠ èŠ‚ç‚¹ï¼ˆScale Outï¼‰**
   - æœ€å¸¸ç”¨æ–¹å¼
   - é€‚åˆæ•°æ®é‡å¢é•¿ã€å†™è´Ÿè½½å¢é•¿
2. **æ›´æ¢èŠ‚ç‚¹ï¼ˆæ›´å¤§ç¡¬ä»¶ / SSDï¼‰**
   - å½“èŠ‚ç‚¹å­˜å‚¨æˆ– IOPS è¾¾åˆ°ç“¶é¢ˆæ—¶
   - ç±»ä¼¼â€œèŠ‚ç‚¹å‡çº§â€ï¼Œä¹Ÿæ˜¯åŠ¨æ€æ‰©å±•çš„ä¸€ç§
3. **å‡å°‘èŠ‚ç‚¹ï¼ˆScale Inï¼‰**
   - æ•°æ®é‡ä¸‹é™æˆ–è¿ç§»åˆ°æ–°é›†ç¾¤
   - éœ€è¦ careful rebalance

------

## 3ï¸âƒ£ æ‰©å®¹æµç¨‹ï¼ˆæ·»åŠ èŠ‚ç‚¹ï¼‰

å‡è®¾å½“å‰é›†ç¾¤æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œä½ æƒ³å¢åŠ åˆ° 5 ä¸ªèŠ‚ç‚¹ï¼š

### æ­¥éª¤ 1ï¼šå‡†å¤‡æ–°èŠ‚ç‚¹

- å®‰è£… ScyllaDBï¼Œç‰ˆæœ¬ä¸é›†ç¾¤ä¸€è‡´
- é…ç½®ç½‘ç»œã€ç«¯å£ã€é˜²ç«å¢™
- è®¾ç½® **Seeds**ï¼ˆé›†ç¾¤çš„ç§å­èŠ‚ç‚¹ï¼‰ï¼Œé€šå¸¸é€‰æ‹©å·²æœ‰èŠ‚ç‚¹

------

### æ­¥éª¤ 2ï¼šåŠ å…¥é›†ç¾¤

- å¯åŠ¨æ–°èŠ‚ç‚¹ï¼Œé…ç½® `auto_bootstrap: true`ï¼ˆé»˜è®¤å¼€å¯ï¼‰
- èŠ‚ç‚¹ä¼šå‘ç§å­èŠ‚ç‚¹æ³¨å†Œè‡ªå·±
- é›†ç¾¤æ›´æ–° **Ring ä¿¡æ¯**ï¼ˆæ¯ä¸ªèŠ‚ç‚¹çš„ token èŒƒå›´ï¼‰

------

### æ­¥éª¤ 3ï¼šæ•°æ®é‡åˆ†å¸ƒï¼ˆStreamingï¼‰

- æ–°èŠ‚ç‚¹ä¼šè‡ªåŠ¨ä»å…¶ä»–èŠ‚ç‚¹æ‹‰å–å¯¹åº” token èŒƒå›´çš„æ•°æ®
- **Streaming** è¿‡ç¨‹ï¼š
  1. Scylla æ ¹æ® partition key è®¡ç®— token
  2. æ‰¾åˆ°åŸæ¥çš„èŠ‚ç‚¹
  3. æŒ‰ token èŒƒå›´è¿ç§»æ•°æ®åˆ°æ–°èŠ‚ç‚¹
- æœŸé—´é›†ç¾¤ä»å¯è¯»å†™ï¼Œä½†å†™å…¥å¯èƒ½ç•¥æœ‰å»¶è¿Ÿ

------

### æ­¥éª¤ 4ï¼šä¸€è‡´æ€§æ£€æŸ¥

- ç¡®ä¿ **replication factor** å’Œ **ä¸€è‡´æ€§çº§åˆ«**è®¾ç½®åˆç†
- æ•°æ®è¿ç§»å®Œæˆåï¼ŒèŠ‚ç‚¹çŠ¶æ€å˜ä¸º `NORMAL`
- å¯ä»¥é€šè¿‡ `nodetool status` æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

------

### æ­¥éª¤ 5ï¼šæ›´æ–°ç›‘æ§å’Œè´Ÿè½½å‡è¡¡

- æ–°èŠ‚ç‚¹åŠ å…¥åï¼š
  - å‡è¡¡å†™å…¥å’ŒæŸ¥è¯¢è¯·æ±‚
  - ç¡®ä¿ç›‘æ§å‘Šè­¦è¦†ç›–æ–°èŠ‚ç‚¹ï¼ˆCPUã€IOã€å»¶è¿Ÿã€ç£ç›˜ä½¿ç”¨ï¼‰
- åˆ†åŒºå’Œè¯·æ±‚ä¼šè‡ªåŠ¨å‡åŒ€åˆ†å¸ƒï¼Œæ— éœ€æ‰‹åŠ¨ shard

------

## 4ï¸âƒ£ åŠ¨æ€æ‰©å±•æ³¨æ„äº‹é¡¹

| æ³¨æ„ç‚¹       | è¯´æ˜                                                         |
| ------------ | ------------------------------------------------------------ |
| Token åˆ†é…   | Scylla é»˜è®¤ä½¿ç”¨ **vnodeï¼ˆè™šæ‹ŸèŠ‚ç‚¹ï¼‰**ï¼Œä¸€ä¸ªèŠ‚ç‚¹åˆ†é…å¤šä¸ª tokenï¼Œæ‰©å®¹æ›´å¹³æ»‘ |
| æ•°æ®è¿ç§»è´Ÿè½½ | å¯ä»¥é€šè¿‡ `throttle` æ§åˆ¶ streaming å¸¦å®½ï¼Œé¿å…å½±å“ä¸šåŠ¡        |
| å†™å…¥ä¸€è‡´æ€§   | æ‰©å®¹è¿‡ç¨‹ä¸­è¯»å†™ä»å¯ç”¨ï¼Œä½†æœ€ç»ˆä¸€è‡´æ€§å¯èƒ½çŸ­æ—¶é—´å»¶è¿Ÿ             |
| èŠ‚ç‚¹ç¡¬ä»¶     | æ‰©å®¹å»ºè®®æ–°èŠ‚ç‚¹ç¡¬ä»¶ä¸è€èŠ‚ç‚¹ä¸€è‡´ï¼Œå¦åˆ™çƒ­ç‚¹å¯èƒ½å‡ºç°             |

------

## 5ï¸âƒ£ Go / è¿ç»´å®è·µ

åœ¨ Go ç³»ç»Ÿé‡Œï¼Œä½ åªéœ€è¦ï¼š

1. æ›´æ–° **Cluster é…ç½®**ï¼ŒæŠŠæ–°èŠ‚ç‚¹ IP åŠ å…¥ seeds æˆ– hosts åˆ—è¡¨
2. ç»§ç»­ä½¿ç”¨ç°æœ‰ **gocql/gocqlx session**
3. Scylla è‡ªåŠ¨æŠŠæ•°æ®å‡åŒ€åˆ†å¸ƒï¼Œä½ æ— éœ€æ”¹æŸ¥è¯¢é€»è¾‘

> é‡ç‚¹æ˜¯ç‰©ç†æ‰©å®¹ç”± Scylla ç®¡ç†ï¼Œåº”ç”¨ç«¯æ— éœ€æ”¹åŠ¨æŸ¥è¯¢é€»è¾‘ï¼Œä»æŒ‰åˆ†åŒºé”®æŸ¥è¯¢å³å¯ã€‚

------

âœ… æ€»ç»“æµç¨‹ï¼š

1. å‡†å¤‡æ–°èŠ‚ç‚¹ï¼ˆå®‰è£…ã€ç½‘ç»œã€ç§å­èŠ‚ç‚¹ï¼‰
2. é…ç½®å¯åŠ¨ï¼Œ`auto_bootstrap: true`
3. èŠ‚ç‚¹æ³¨å†Œé›†ç¾¤ â†’ æ›´æ–° Ring ä¿¡æ¯
4. Streaming æ•°æ®è¿ç§» â†’ èŠ‚ç‚¹çŠ¶æ€ `NORMAL`
5. æ£€æŸ¥ä¸€è‡´æ€§ & ç›‘æ§ â†’ æ‰©å®¹å®Œæˆ



ç³»ç»Ÿåœ°æ¢³ç†ä¸€ä¸‹ **ScyllaDB/Cassandra ä¸­çš„ç§å­èŠ‚ç‚¹ï¼ˆSeed Nodeï¼‰å’Œæ™®é€šæ•°æ®èŠ‚ç‚¹ï¼ˆData Nodeï¼‰** çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒä»¬åœ¨é›†ç¾¤ä¸­çš„è§’è‰²ã€‚

------

# äºŒã€ç§å­èŠ‚ç‚¹ä¸æ•°æ®èŠ‚ç‚¹

## 1ï¸âƒ£ åŸºæœ¬æ¦‚å¿µ

### ğŸ”¹ æ•°æ®èŠ‚ç‚¹ï¼ˆData Nodeï¼‰

- é›†ç¾¤ä¸­çš„æ™®é€šèŠ‚ç‚¹ï¼Œå­˜å‚¨å®é™…æ•°æ®
- è´Ÿè´£ï¼š
  - ä¿å­˜åˆ†åŒºé”®å¯¹åº”çš„æ•°æ®
  - å“åº”å®¢æˆ·ç«¯çš„è¯»å†™è¯·æ±‚
  - å‚ä¸åˆ†å¸ƒå¼å¤åˆ¶å’Œä¸€è‡´æ€§æœºåˆ¶
- æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„ token èŒƒå›´ï¼ˆè´Ÿè´£é›†ç¾¤ä¸­æŸéƒ¨åˆ†æ•°æ®ï¼‰

------

### ğŸ”¹ ç§å­èŠ‚ç‚¹ï¼ˆSeed Nodeï¼‰

- ä¸æ˜¯ç‰¹æ®Šå­˜å‚¨èŠ‚ç‚¹ï¼Œä¹Ÿä¸è´Ÿè´£é¢å¤–çš„æ•°æ®å­˜å‚¨
- ä¸»è¦ä½œç”¨ï¼š
  1. **æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å¼•å¯¼**
     - æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶éœ€è¦çŸ¥é“è‡³å°‘ä¸€ä¸ª seed èŠ‚ç‚¹çš„ IP
     - é€šè¿‡ seed èŠ‚ç‚¹è·å–é›†ç¾¤å…ƒä¿¡æ¯ï¼ˆèŠ‚ç‚¹åˆ—è¡¨ã€token ringï¼‰
  2. **å…ƒæ•°æ®ä¼ æ’­**
     - å¸®åŠ©æ–°èŠ‚ç‚¹å¿«é€Ÿäº†è§£é›†ç¾¤æ‹“æ‰‘ç»“æ„
- **ä¸å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä¹Ÿå¯ä»¥**ï¼ˆå¯é€‰ä½œä¸ºæ•°æ®èŠ‚ç‚¹å‚ä¸è¯»å†™ï¼‰
- é›†ç¾¤ä¸­å¯ä»¥æœ‰å¤šä¸ª seed èŠ‚ç‚¹ï¼Œä¸€èˆ¬ **2~3 ä¸ªè¶³å¤Ÿ**
- ç§å­èŠ‚ç‚¹ä¿¡æ¯åœ¨å¯åŠ¨é…ç½®ä¸­å›ºå®šï¼Œä¸€æ—¦å¯åŠ¨åï¼Œæ–°èŠ‚ç‚¹åªç”¨ seeds å¼•å¯¼ï¼Œä¸ä¼šé‡å¤å¹¿æ’­

------

## 2ï¸âƒ£ Seed Node ä¸ Data Node çš„åŒºåˆ«è¡¨æ ¼

| ç‰¹æ€§       | ç§å­èŠ‚ç‚¹                   | æ™®é€šæ•°æ®èŠ‚ç‚¹                 |
| ---------- | -------------------------- | ---------------------------- |
| æ•°æ®å­˜å‚¨   | âœ… å¯ä»¥å­˜å‚¨æ•°æ®ï¼ˆå¯é€‰ï¼‰     | âœ… å­˜å‚¨æ•°æ®                   |
| å®¢æˆ·ç«¯è¯»å†™ | å¯å¤„ç†ï¼Œä¹Ÿå¯ä¸å¤„ç†         | âœ… å¤„ç†è¯»å†™                   |
| é›†ç¾¤å¼•å¯¼   | âœ… æ–°èŠ‚ç‚¹é€šè¿‡å®ƒåŠ å…¥é›†ç¾¤     | âŒ ä¸ä½œä¸ºåˆå§‹å¼•å¯¼             |
| å…ƒæ•°æ®ä¼ æ’­ | âœ… è´Ÿè´£ä¼ æ’­æ‹“æ‰‘ä¿¡æ¯ç»™æ–°èŠ‚ç‚¹ | âŒ ä»…å‚ä¸ token ring å¤åˆ¶     |
| æ•°é‡       | å°‘é‡ï¼ˆ2~3 ä¸ªï¼‰             | å¤šä¸ªï¼ŒæŒ‰ä¸šåŠ¡è´Ÿè½½å’Œæ•°æ®é‡æ‰©å±• |
| é…ç½®å˜åŒ–   | é™æ€ï¼Œé…ç½®æ–‡ä»¶é‡ŒæŒ‡å®š       | åŠ¨æ€åŠ å…¥/ç¦»å¼€ç”±é›†ç¾¤åè°ƒ      |

------

## 3ï¸âƒ£ Seed èŠ‚ç‚¹å·¥ä½œåŸç†

1. æ–°èŠ‚ç‚¹å¯åŠ¨ï¼š
   - è¯»å–æœ¬åœ°é…ç½®çš„ seed èŠ‚ç‚¹åˆ—è¡¨
2. è¿æ¥ä»»æ„ä¸€ä¸ª seed èŠ‚ç‚¹
3. Seed èŠ‚ç‚¹è¿”å›å½“å‰é›†ç¾¤çš„èŠ‚ç‚¹åˆ—è¡¨å’Œ token ä¿¡æ¯
4. æ–°èŠ‚ç‚¹åˆ†é… token èŒƒå›´ï¼Œå¼€å§‹æ¥æ”¶æ•°æ®ï¼ˆstreamingï¼‰
5. ä¹‹åæ–°èŠ‚ç‚¹å°±æˆä¸ºé›†ç¾¤çš„ä¸€å‘˜ï¼Œseed èŠ‚ç‚¹ä¸å†ç‰¹æ®Šå‚ä¸å®ƒçš„æ“ä½œ

> ğŸ”¹ **å…³é”®ç‚¹**ï¼šç§å­èŠ‚ç‚¹åªæ˜¯é›†ç¾¤å¯åŠ¨å’ŒåŠ å…¥èŠ‚ç‚¹çš„å¼•å¯¼ï¼Œä¸æ˜¯â€œä¸»èŠ‚ç‚¹â€ï¼Œä¹Ÿæ²¡æœ‰å•ç‚¹ç“¶é¢ˆã€‚

------

## 4ï¸âƒ£ å®é™…å»ºè®®

- é›†ç¾¤å¯åŠ¨è‡³å°‘æŒ‡å®š 2-3 ä¸ªç§å­èŠ‚ç‚¹ï¼Œåˆ†å¸ƒåœ¨ä¸åŒæœºæ¶/æ•°æ®ä¸­å¿ƒï¼Œä¿è¯é«˜å¯ç”¨
- æ•°æ®èŠ‚ç‚¹å¯éšä¸šåŠ¡æ‰©å®¹/ç¼©å®¹ï¼Œseed èŠ‚ç‚¹ä¿æŒç¨³å®š
- ç§å­èŠ‚ç‚¹æ•°é‡è¿‡å¤šæ²¡å¿…è¦ï¼Œè¿‡å°‘å¯èƒ½åœ¨èŠ‚ç‚¹å…¨ä¸¢å¤±åå¯¼è‡´æ–°èŠ‚ç‚¹æ— æ³•åŠ å…¥



# ä¸‰ã€æµç¨‹å›¾

## 1ï¸âƒ£ Scylla/Cassandra é›†ç¾¤å‘ç°æœºåˆ¶

- **Seeds èŠ‚ç‚¹**
  - æ¯ä¸ªèŠ‚ç‚¹åœ¨å¯åŠ¨æ—¶ï¼Œä¼šè”ç³» seeds èŠ‚ç‚¹ï¼Œè·å–é›†ç¾¤çš„èŠ‚ç‚¹åˆ—è¡¨å’Œ token ring
  - seeds èŠ‚ç‚¹åªç”¨ä½œåˆæ¬¡å‘ç°é›†ç¾¤ä¿¡æ¯ï¼Œä¸å‚ä¸è´Ÿè½½å‡è¡¡
- **Cluster Metadata**
  - é©±åŠ¨ï¼ˆGo çš„ gocql/gocqlxï¼‰ä¼šç»´æŠ¤é›†ç¾¤å…ƒä¿¡æ¯ï¼š
    - èŠ‚ç‚¹åˆ—è¡¨ã€çŠ¶æ€ï¼ˆUP/DOWNï¼‰ã€token èŒƒå›´
  - é©±åŠ¨ä¼šå®šæœŸåˆ·æ–° metadataï¼Œè‡ªåŠ¨æ„ŸçŸ¥èŠ‚ç‚¹åŠ å…¥/ä¸‹çº¿
- **è‡ªåŠ¨è´Ÿè½½å‡è¡¡**
  - gocql driver æ ¹æ®åˆ†åŒºé”®è®¡ç®— tokenï¼Œç„¶åè·¯ç”±åˆ°æ­£ç¡®èŠ‚ç‚¹
  - ä¸éœ€è¦åº”ç”¨è‡ªå·±å»ç»´æŠ¤èŠ‚ç‚¹ IP

------

## 2ï¸âƒ£ Go åº”ç”¨å®è·µ

### é…ç½®ç¤ºä¾‹

```go
cluster := gocql.NewCluster("192.168.1.10", "192.168.1.11") // seeds
cluster.Keyspace = "chatdata"
cluster.Consistency = gocql.Quorum
cluster.PoolConfig.HostSelectionPolicy = gocql.TokenAwareHostPolicy(gocql.DCAwareRoundRobinPolicy("datacenter1"))

session, err := cluster.CreateSession()
if err != nil {
    log.Fatal(err)
}
defer session.Close()
```

- **åŠ¨æ€æ„ŸçŸ¥èŠ‚ç‚¹**ï¼š
  - å½“æ–°èŠ‚ç‚¹åŠ å…¥ clusterï¼Œé©±åŠ¨çš„ **metadata updater** ä¼šè‡ªåŠ¨åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨
  - session æ— éœ€é‡å»ºï¼ŒæŸ¥è¯¢è·¯ç”±ä¼šè‡ªåŠ¨æ›´æ–°
- **èŠ‚ç‚¹ä¸‹çº¿**ï¼š
  - é©±åŠ¨ä¼šæ ‡è®°èŠ‚ç‚¹ `DOWN`ï¼Œé¿å…è·¯ç”±è¯·æ±‚åˆ°å¤±æ•ˆèŠ‚ç‚¹

------

## 3ï¸âƒ£ ä»€ä¹ˆæ—¶å€™éœ€è¦é¢å¤–åå­—æœåŠ¡

- å¦‚æœä½ çš„ IP æ˜¯åŠ¨æ€åˆ†é…çš„ï¼ˆæ¯”å¦‚ Kubernetes podï¼‰ï¼Œè€Œä¸”é›†ç¾¤èŠ‚ç‚¹ç»å¸¸å˜åŒ–ï¼š
  - å¯ä»¥ç»“åˆ **K8s headless service** æˆ– **Consul/Etcd** æä¾›ç§å­èŠ‚ç‚¹åˆ—è¡¨
  - é©±åŠ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ç§å­èŠ‚ç‚¹åˆ—è¡¨å³å¯
- ä½†æ™®é€šé™æ€ IP é›†ç¾¤ï¼Œ**ä¸éœ€è¦é¢å¤–åå­—æœåŠ¡**

------

## 4ï¸âƒ£ æ€»ç»“

| æƒ…å†µ                    | æ˜¯å¦éœ€è¦åå­—æœåŠ¡                                    |
| ----------------------- | --------------------------------------------------- |
| é™æ€ IP é›†ç¾¤            | âŒ ä¸éœ€è¦ï¼Œç›´æ¥ seeds å°±è¡Œ                           |
| åŠ¨æ€ IP / å®¹å™¨åŒ–ç¯å¢ƒ    | âœ… å¯ä»¥é€šè¿‡ K8s Service / Consul æä¾› seeds åŠ¨æ€è§£æ |
| é©±åŠ¨è¿è¡Œæ—¶èŠ‚ç‚¹åŠ å…¥/ä¸‹çº¿ | âŒ é©±åŠ¨ä¼šè‡ªåŠ¨åˆ·æ–° metadataï¼Œæ— éœ€åº”ç”¨å¹²é¢„             |

> æ ¸å¿ƒï¼š**Go é©±åŠ¨é€šè¿‡ seeds èŠ‚ç‚¹å’Œ metadata updater è‡ªåŠ¨æ„ŸçŸ¥é›†ç¾¤çŠ¶æ€ï¼Œåº”ç”¨æ— éœ€è‡ªå·±ç®¡ç†èŠ‚ç‚¹åˆ—è¡¨**