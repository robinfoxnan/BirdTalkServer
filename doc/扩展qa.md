**IMæœåŠ¡å™¨å°†æ‰©å±•çš„æ¶ˆæ¯ç±»å‹éƒ½è½¬ç»™åç«¯å…¶ä»–çš„å¾®æœåŠ¡ï¼Œç”¨GRPCæ¥è°ƒç”¨ï¼Œç”¨ETCDå®Œæˆæ³¨å†Œï¼Œ**

ç»“è®ºå…ˆç»™ä½ ï¼š**è¿™æ˜¯ä¸€ä¸ªéå¸¸åˆç†ã€è€Œä¸”æ˜¯â€œåå·¥ç¨‹åŒ–æ­£ç¡®â€çš„æ¶æ„æ–¹å‘**ï¼Œå°¤å…¶æ˜¯ä½ ç°åœ¨åšçš„æ˜¯ **IM + æ‰©å±•æ¶ˆæ¯ç±»å‹ï¼ˆéŸ³è§†é¢‘ / çº¢åŒ… / æœºå™¨äºº / ä¸šåŠ¡å¡ç‰‡ / AI ç­‰ï¼‰** çš„åœºæ™¯ã€‚
ä½†å®ƒ**æ˜¯å¦â€œå¥½ç”¨ã€å¯æ‰©å±•ã€ä¸ç¿»è½¦â€å–å†³äºä½ æ€ä¹ˆåˆ‡åˆ†ã€æ€ä¹ˆå…œåº•ã€æ€ä¹ˆé™æµ**ã€‚

ä¸‹é¢æˆ‘ä» **åˆç†æ€§ â†’ æ¨èæ¶æ„ â†’ å…³é”®è®¾è®¡ç‚¹ â†’ å¸¸è§å‘** å››ä¸ªå±‚æ¬¡ç»™ä½ ä¸€ä¸ªå·¥ç¨‹è§†è§’çš„åˆ†æã€‚

------

## ä¸€ã€æ•´ä½“æ¶æ„åˆ¤æ–­ï¼šâœ” åˆç†ï¼Œè€Œä¸”æ˜¯ä¸»æµåšæ³•

ä½ æè¿°çš„æ˜¯ï¼š

> **IM Serverï¼ˆæ ¸å¿ƒï¼‰**
> â†’ æŠŠã€Œæ‰©å±•æ¶ˆæ¯ç±»å‹ã€è½¬å‘
> â†’ è°ƒç”¨ **åç«¯å¾®æœåŠ¡ï¼ˆgRPCï¼‰**
> â†’ ç”¨ **etcd åšæœåŠ¡æ³¨å†Œ/å‘ç°**

è¿™æœ¬è´¨æ˜¯ä¸€ä¸ªï¼š

> **â€œè½»æ ¸å¿ƒ IM + æ’ä»¶åŒ–/ä¸šåŠ¡å¾®æœåŠ¡â€ æ¶æ„**

è¿™æ˜¯ **ä¼ä¸šçº§ IM / æ¸¸æˆæœåŠ¡å™¨ / AI èŠå¤©å¹³å°** çš„å¸¸è§æ–¹æ¡ˆã€‚

### ä¸ºä»€ä¹ˆåˆç†ï¼Ÿ

| ç‚¹            | åŸå›                                        |
| ------------- | ------------------------------------------ |
| IM æ ¸å¿ƒä¿æŒè½» | ç™»å½• / è¿æ¥ / è·¯ç”± / æŠ•é€’ æ˜¯é«˜ QPSã€ä½å»¶è¿Ÿ |
| æ‰©å±•æ¶ˆæ¯å¤æ‚  | çº¢åŒ…ã€æ–‡ä»¶ã€è¯­éŸ³ã€AI éƒ½æ˜¯**é‡é€»è¾‘**        |
| gRPC          | é«˜æ€§èƒ½ã€å¼ºçº¦æŸã€IDL æ˜ç¡®                   |
| etcd          | åŠ¨æ€æ‰©ç¼©å®¹ã€æœåŠ¡æ„ŸçŸ¥                       |
| è§£è€¦          | ä¸åŒå›¢é˜Ÿ/æ¨¡å—ç‹¬ç«‹æ¼”è¿›                      |

ğŸ‘‰ **ä½ è¿™ä¸ªæ€è·¯æ˜¯â€œå¯¹çš„â€ï¼Œä¸æ˜¯é‡è·¯å­ã€‚**

------

## äºŒã€æ¨èçš„ã€Œæ ‡å‡†æ‹†åˆ†å½¢æ€ã€

### 1ï¸âƒ£ IM æ ¸å¿ƒæœåŠ¡ï¼ˆä¸€å®šè¦å…‹åˆ¶ï¼‰

**IM Server åªå¹² 5 ä»¶äº‹ï¼š**

```text
- è¿æ¥ç®¡ç†ï¼ˆTCP / WSï¼‰
- é‰´æƒ & Session
- æ¶ˆæ¯è·¯ç”±ï¼ˆto user / groupï¼‰
- é¡ºåº & æŠ•é€’ä¿è¯
- ACK / é‡å‘ / ç¦»çº¿
```

ğŸš« **ä¸è¦åšè¿™äº›ï¼š**

- çº¢åŒ…é€»è¾‘
- æ–‡ä»¶è½¬ç 
- è¯­éŸ³å¤„ç†
- AI è°ƒç”¨
- ä¸šåŠ¡çŠ¶æ€æœº

å¦åˆ™ IM Server ä¼šå˜æˆã€Œä¸Šå¸è¿›ç¨‹ã€ã€‚

------

### 2ï¸âƒ£ æ‰©å±•æ¶ˆæ¯å¤„ç†æœåŠ¡ï¼ˆä½ è¯´çš„â€œå¾®æœåŠ¡â€ï¼‰

ä¾‹å¦‚ï¼š

```text
msg-image-service
msg-audio-service
msg-video-service
msg-redpacket-service
msg-ai-service
msg-bot-service
```

æ¯ä¸ªæœåŠ¡ï¼š

- gRPC æš´éœ²ç»Ÿä¸€æ¥å£
- åªå…³å¿ƒè‡ªå·±çš„ä¸šåŠ¡
- å¯ä»¥æ°´å¹³æ‰©å±•
- å¯ç‹¬ç«‹éƒ¨ç½²/é‡å¯

------

### 3ï¸âƒ£ gRPC è°ƒç”¨é“¾ï¼ˆæ¨èåŒæ­¥ + å¼‚æ­¥æ··åˆï¼‰

**ä¸æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½è¦åŒæ­¥è¿”å›ï¼**

| ç±»å‹     | æ¨¡å¼                  |
| -------- | --------------------- |
| æ™®é€šæ–‡æœ¬ | IM ç›´æ¥å¤„ç†           |
| çº¢åŒ…     | åŒæ­¥æ ¡éªŒ â†’ å¼‚æ­¥å‘ç»“æœ |
| å›¾ç‰‡     | åŒæ­¥æ ¡éªŒ â†’ å¼‚æ­¥å¤„ç†   |
| AI       | **å¼ºçƒˆå»ºè®®å¼‚æ­¥**      |
| å¤§æ–‡ä»¶   | ç»å¯¹ä¸è¦é˜»å¡ IM       |

------

## ä¸‰ã€ä½ è¿™ä¸ªæ¶æ„é‡Œï¼Œ**æœ€å…³é”®çš„ 6 ä¸ªè®¾è®¡ç‚¹**

### ğŸ”‘ 1ï¸âƒ£ IM Server å¿…é¡»æ˜¯ã€Œè·¯ç”±å™¨ã€ï¼Œä¸æ˜¯ã€Œä¸šåŠ¡æ‰§è¡Œå™¨ã€

æ¨èæ¨¡å¼ï¼š

```text
å®¢æˆ·ç«¯ â†’ IM Server
IM Server â†’ æ‰©å±•æœåŠ¡ï¼ˆæ ¡éªŒ / ç”Ÿæˆç³»ç»Ÿæ¶ˆæ¯ï¼‰
IM Server â† ç»“æœ / äº‹ä»¶
IM Server â†’ æŠ•é€’ç»™ç”¨æˆ·
```

IM Server **ä¸å…³å¿ƒçº¢åŒ…é’±æ€ä¹ˆç®—**ï¼Œåªå…³å¿ƒï¼š

> â€œè¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œè¦ä¸è¦æŠ•é€’â€

------

### ğŸ”‘ 2ï¸âƒ£ æ‰©å±•æ¶ˆæ¯è¦æœ‰ã€Œç»Ÿä¸€ Envelopeã€

ä¸è¦ç›´æ¥è£¸ä¼ ä¸šåŠ¡æ•°æ®ã€‚

æ¨èï¼š

```proto
message ExtMessage {
  string msg_id;
  string from;
  string to;
  string type;        // image / redpacket / ai
  bytes payload;      // protobuf / json
  map<string,string> meta;
}
```

è¿™æ ·ï¼š

- IM Server **ä¸éœ€è¦ç†è§£ payload**
- æ–°ç±»å‹æ— éœ€æ”¹ IM åè®®
- å®¢æˆ·ç«¯ä¹Ÿå¥½æ‰©å±•

------

### ğŸ”‘ 3ï¸âƒ£ gRPC ä¸€å®šè¦æœ‰ã€Œè¶…æ—¶ + ç†”æ–­ã€

**è¿™æ˜¯ IM ç³»ç»Ÿç”Ÿæ­»çº¿**

```text
- å•æ¬¡ gRPC è¶…æ—¶ï¼š10~50msï¼ˆè§†ä¸šåŠ¡ï¼‰
- è¶…æ—¶ç›´æ¥è¿”å›ã€Œå¤„ç†ä¸­ã€
- ç»å¯¹ä¸èƒ½å¡ä½ IM ä¸»çº¿ç¨‹
```

å»ºè®®ï¼š

- æ¯ç§æ‰©å±•æœåŠ¡ **ç‹¬ç«‹è¿æ¥æ± **
- å•ç‹¬ goroutine / thread pool

------

### ğŸ”‘ 4ï¸âƒ£ etcd ç”¨æ¥åšã€Œå‘ç° + é…ç½®ã€ï¼Œä¸æ˜¯ RPC

etcd çš„æ­£ç¡®å§¿åŠ¿ï¼š

- æœåŠ¡æ³¨å†Œ
- æœåŠ¡åˆ—è¡¨
- æƒé‡ / æ ‡ç­¾
- ç°åº¦é…ç½®
- Feature Flag

ğŸš« ä¸è¦ï¼š

- æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥ etcd
- æŠŠ etcd å½“æ•°æ®åº“

------

### ğŸ”‘ 5ï¸âƒ£ å¿…é¡»æœ‰ã€Œé™çº§è·¯å¾„ã€

å¦‚æœæŸä¸ªæ‰©å±•æœåŠ¡æŒ‚äº†ï¼š

| åœºæ™¯       | è¡Œä¸º                 |
| ---------- | -------------------- |
| çº¢åŒ…æœåŠ¡æŒ‚ | è¿”å›ã€Œæš‚ä¸å¯ç”¨ã€     |
| AI æŒ‚      | ç›´æ¥è·³è¿‡ï¼Œä¸å½±å“èŠå¤© |
| å›¾ç‰‡å¤„ç†æŒ‚ | å…ˆå‘å ä½æ¶ˆæ¯         |

**IM æœ¬èº«ä¸èƒ½æŒ‚ã€‚**

------

### ğŸ”‘ 6ï¸âƒ£ æ¶ˆæ¯ä¸€å®šè¦ã€Œå¹‚ç­‰ + å¯é‡æ”¾ã€

IM åœºæ™¯å¿…ç„¶å‡ºç°ï¼š

- é‡è¿
- é‡å‘
- è¶…æ—¶é‡è¯•

æ‰©å±•æœåŠ¡æ¥å£å¿…é¡»ï¼š

```text
- æ”¯æŒ msg_id å¹‚ç­‰
- å¯ä»¥é‡æ”¾
- ä¸ä¾èµ–è°ƒç”¨é¡ºåº
```

------

## å››ã€ä¸€ä¸ªã€Œæˆç†Ÿçš„å‚è€ƒå½¢æ€ã€ï¼ˆç®€åŒ–ç‰ˆï¼‰

```text
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Client   â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    IM Server   â”‚
        â”‚  Conn / Route  â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
            â”‚         â”‚
    gRPC Sync       MQ / Event
            â”‚         â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Ext Svc  â”‚   â”‚ Async Svc  â”‚
   â”‚ (çº¢åŒ…)   â”‚   â”‚ (AI/éŸ³é¢‘)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–²
        etcd æ³¨å†Œå‘ç°
```

------

## äº”ã€ä»€ä¹ˆæ—¶å€™ã€Œä¸é€‚åˆã€è¿™æ ·åšï¼Ÿ

âŒ å°é¡¹ç›® / å•ä½“åº”ç”¨
âŒ QPS å¾ˆä½
âŒ æ²¡æœ‰è¿ç»´èƒ½åŠ›
âŒ æ²¡æœ‰é“¾è·¯è¿½è¸ª / æ—¥å¿— / æŒ‡æ ‡

ğŸ‘‰ é‚£ç§æƒ…å†µä¸‹ **å…ˆå•ä½“ï¼Œæ¥å£ç•™å¥½å°±è¡Œ**ã€‚

------

## æœ€åä¸€å¥ç»™ä½ ä¸€ä¸ªå·¥ç¨‹åˆ¤æ–­

> **ä½ è¿™ä¸ªè®¾è®¡ï¼Œå·²ç»ç«™åœ¨â€œå¯ä»¥é•¿æœŸæ¼”è¿›â€çš„é‚£ä¸€è¾¹äº†ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

- è®¾è®¡ä¸€å¥— **ExtMessage proto**
- ç»™ä½  **IM â†’ ExtService gRPC æ¥å£è§„èŒƒ**
- æˆ–ç›´æ¥ **è¯„å®¡ä½ ç°æœ‰çš„æ¶ˆæ¯ç±»å‹æ‹†åˆ†æ˜¯å¦åˆç†**

ä½ ç°åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¾ˆæ˜æ˜¾ä¸æ˜¯â€œç©ç©â€çš„é¡¹ç›® ğŸ‘





å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥**éå¸¸å…³é”®**ï¼Œè€Œä¸”ä½ æçš„ä¸¤ä¸ªç‚¹ï¼ˆ`ExtMessage proto` + `IM â†’ ExtService gRPC æ¥å£è§„èŒƒ`ï¼‰æœ¬è´¨ä¸Šæ˜¯ä¸€ä»¶äº‹ï¼š
ğŸ‘‰ **å®šä¹‰ IM æ ¸å¿ƒä¸ä¸šåŠ¡æ‰©å±•ä¹‹é—´çš„â€œå¥‘çº¦å±‚â€**ã€‚

ä¸‹é¢æˆ‘ç»™ä½ ä¸€å¥— **å¯ç›´æ¥è½åœ°ã€åä¼ä¸šçº§ã€é•¿æœŸå¯æ¼”è¿›** çš„è®¾è®¡ï¼ˆä¸æ˜¯ç©å…·ç‰ˆï¼‰ã€‚

------

# ä¸€ã€è®¾è®¡ç›®æ ‡ï¼ˆå…ˆç»Ÿä¸€æ€æƒ³ï¼‰

è¿™å¥—è®¾è®¡è¦æ»¡è¶³ï¼š

1. **IM Server ä¸ç†è§£ä¸šåŠ¡**
2. **æ–°å¢æ¶ˆæ¯ç±»å‹ä¸æ”¹ IM åè®®**
3. **æ”¯æŒåŒæ­¥ / å¼‚æ­¥**
4. **å¤©ç„¶æ”¯æŒå¹‚ç­‰ / é‡è¯•**
5. **å®¢æˆ·ç«¯ & æœåŠ¡ç«¯éƒ½å¯æ‰©å±•**
6. **èƒ½è¢«å¤šè¯­è¨€ gRPC ä½¿ç”¨ï¼ˆGo / Java / Kotlinï¼‰**

------

# äºŒã€æ ¸å¿ƒæ¦‚å¿µæ‹†åˆ†ï¼ˆéå¸¸é‡è¦ï¼‰

æˆ‘ä»¬æŠŠã€Œæ‰©å±•æ¶ˆæ¯ã€æ‹†æˆ **3 å±‚ç»“æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ExtMessageEnvelope   â”‚  â† IM å±‚ç»Ÿä¸€å¤–å£³ï¼ˆå¿…é¡»ç¨³å®šï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ExtMessageHeader     â”‚  â† è·¯ç”± / æ§åˆ¶ / å¹‚ç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ExtMessageBody       â”‚  â† ä¸šåŠ¡ payloadï¼ˆExtService è´Ÿè´£ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

------

# ä¸‰ã€ExtMessage protoï¼ˆæ ¸å¿ƒå®šä¹‰ï¼‰

### ğŸ“Œ ext_message.proto

```proto
syntax = "proto3";

package im.ext;

option go_package = "im/ext;extpb";
option java_multiple_files = true;
option java_package = "com.example.im.ext";
option java_outer_classname = "ExtMessageProto";

/**
 * æ‰©å±•æ¶ˆæ¯ç»Ÿä¸€ Envelope
 * IM Server åªç†è§£è¿™ä¸€å±‚
 */
message ExtMessage {

  // ========== åŸºç¡€æ ‡è¯† ==========
  string msg_id        = 1;  // å…¨å±€å”¯ä¸€ï¼ˆå®¢æˆ·ç«¯æˆ– IM ç”Ÿæˆï¼‰
  string conversation  = 2;  // ä¼šè¯IDï¼ˆå•èŠ / ç¾¤èŠï¼‰
  string from_uid      = 3;
  string to_uid        = 4;  // å•èŠå¯ç”¨ï¼Œç¾¤èŠä¸ºç©º
  string group_id      = 5;  // ç¾¤èŠå¯ç”¨

  // ========== æ¶ˆæ¯å±æ€§ ==========
  string msg_type      = 10; // image / audio / redpacket / ai
  MsgScene scene       = 11; // chat / system / control

  // ========== æ—¶é—´ & é¡ºåº ==========
  int64  client_ts     = 20; // å®¢æˆ·ç«¯æ—¶é—´
  int64  server_ts     = 21; // IM Server å†™å…¥
  int64  seq           = 22; // ä¼šè¯å†…åºåˆ—å·

  // ========== æ‰©å±•æ§åˆ¶ ==========
  ExtHeader header     = 30;
  bytes     payload    = 31; // ä¸šåŠ¡æ•°æ®ï¼ˆprotobuf / jsonï¼‰

  // ========== æ‰§è¡Œç»“æœï¼ˆIM å†™å…¥ï¼‰ ==========
  MsgStatus status     = 40;
}

/**
 * æ¶ˆæ¯å¤´ï¼šæ§åˆ¶ & å¹‚ç­‰ & è·¯ç”±
 */
message ExtHeader {
  string request_id    = 1;   // gRPC è°ƒç”¨é“¾ID
  bool   need_ack      = 2;   // æ˜¯å¦éœ€è¦å®¢æˆ·ç«¯ACK
  bool   async         = 3;   // æ˜¯å¦å¼‚æ­¥å¤„ç†
  int32  timeout_ms    = 4;   // æ‰©å±•æœåŠ¡å¤„ç†è¶…æ—¶å»ºè®®
  map<string,string> tags = 5; // ç°åº¦ / AB / Feature Flag
}

/**
 * æ¶ˆæ¯çŠ¶æ€ï¼ˆIM Server ç»´æŠ¤ï¼‰
 */
enum MsgStatus {
  MSG_UNKNOWN   = 0;
  MSG_PENDING   = 1;  // å·²æ¥æ”¶ï¼Œå¤„ç†ä¸­
  MSG_SUCCESS   = 2;  // ä¸šåŠ¡æˆåŠŸ
  MSG_FAILED    = 3;  // ä¸šåŠ¡å¤±è´¥
  MSG_REJECTED  = 4;  // æ ¡éªŒä¸é€šè¿‡
}

enum MsgScene {
  SCENE_CHAT    = 0;
  SCENE_SYSTEM  = 1;
  SCENE_CONTROL = 2;
}
```

> âš ï¸ **å…³é”®ç‚¹**
>
> - `payload` æ˜¯ `bytes`ï¼šIM Server æ°¸è¿œä¸å…³å¿ƒå†…éƒ¨ç»“æ„
> - `msg_type` ç”¨ stringï¼Œä¸ç”¨ enumï¼ˆä¸ºäº†æ‰©å±•ä¸å‘ç‰ˆï¼‰

------

# å››ã€IM â†’ ExtService gRPC æ¥å£è§„èŒƒ

### ğŸ“Œ ext_service.proto

```proto
syntax = "proto3";

package im.ext;

option go_package = "im/ext;extpb";
option java_multiple_files = true;
option java_package = "com.example.im.ext";
option java_outer_classname = "ExtServiceProto";

/**
 * æ‰©å±•æ¶ˆæ¯å¤„ç†æœåŠ¡
 * æ¯ä¸ª msg_type å¯å¯¹åº”ä¸€ä¸ªæœåŠ¡ï¼Œä¹Ÿå¯å¤ç”¨
 */
service ExtMessageService {

  /**
   * åŒæ­¥å¤„ç†ï¼ˆè½»é€»è¾‘ï¼‰
   * - æ ¡éªŒ
   * - ç”Ÿæˆç³»ç»Ÿæ¶ˆæ¯
   * - è¿”å›å¤„ç†ç»“æœ
   */
  rpc Handle (ExtHandleRequest) returns (ExtHandleResponse);

  /**
   * å¼‚æ­¥å¤„ç†ï¼ˆé‡é€»è¾‘ï¼‰
   * - AI
   * - éŸ³è§†é¢‘
   * - è½¬ç 
   */
  rpc HandleAsync (ExtHandleRequest) returns (ExtHandleAck);
}
```

------

### è¯·æ±‚ / å“åº”å®šä¹‰

```proto
message ExtHandleRequest {
  ExtMessage message = 1;
}

message ExtHandleResponse {

  // æ˜¯å¦å…è®¸æŠ•é€’
  bool accept = 1;

  // å¤±è´¥åŸå› ï¼ˆç»™å®¢æˆ·ç«¯æˆ–æ—¥å¿—ï¼‰
  string reason = 2;

  // ä¸šåŠ¡ç”Ÿæˆçš„â€œæ´¾ç”Ÿæ¶ˆæ¯â€
  repeated ExtMessage generated = 3;

  // æ˜¯å¦éœ€è¦æ›´æ–°åŸæ¶ˆæ¯çŠ¶æ€
  MsgStatus status = 4;
}

message ExtHandleAck {
  string request_id = 1;
  bool accepted     = 2;
}
```

------

# äº”ã€è°ƒç”¨æ—¶åºï¼ˆéå¸¸å…³é”®ï¼‰

### åŒæ­¥æ¶ˆæ¯ï¼ˆå¦‚çº¢åŒ…æ ¡éªŒï¼‰

```text
Client â†’ IM
IM â†’ ExtService.Handle
ExtService â†’ IMï¼ˆaccept + system msgï¼‰
IM â†’ Clientï¼ˆæŠ•é€’ï¼‰
```

### å¼‚æ­¥æ¶ˆæ¯ï¼ˆAI / éŸ³è§†é¢‘ï¼‰

```text
Client â†’ IM
IM â†’ ExtService.HandleAsync
IM â†’ Clientï¼ˆMSG_PENDINGï¼‰
ExtService â†’ Event / Callback
IM â†’ Clientï¼ˆæœ€ç»ˆæ¶ˆæ¯ï¼‰
```

------

# å…­ã€å¹‚ç­‰ & é‡è¯•è§„åˆ™ï¼ˆå¼ºçƒˆå»ºè®®ä½ å†™è¿›æ–‡æ¡£ï¼‰

| å­—æ®µ        | è§„åˆ™            |
| ----------- | --------------- |
| msg_id      | å…¨å±€å¹‚ç­‰é”®      |
| request_id  | å•æ¬¡è°ƒç”¨é“¾      |
| Handle      | å¿…é¡»å¹‚ç­‰        |
| HandleAsync | å…è®¸é‡å¤è°ƒç”¨    |
| generated   | å¿…é¡»å¸¦æ–° msg_id |

------

# ä¸ƒã€ä¸€ä¸ªå…·ä½“ç¤ºä¾‹ï¼šçº¢åŒ…æ¶ˆæ¯

```text
msg_type = "redpacket"
payload  = RedPacketPayload(proto)
```

ExtService è¿”å›ï¼š

```text
generated:
  - ç³»ç»Ÿæ¶ˆæ¯ï¼šxx å‘äº†ä¸€ä¸ªçº¢åŒ…
status = MSG_SUCCESS
```

IM Serverï¼š

- ä¸ç†è§£çº¢åŒ…
- åªè´Ÿè´£æŠ•é€’

------

# å…«ã€ä¸ºä»€ä¹ˆè¿™å¥—è®¾è®¡â€œè€ç”¨â€

âœ” æ–°æ¶ˆæ¯ç±»å‹ = æ–° payload
âœ” æ–°æœåŠ¡ = æ–° gRPC å®ç°
âœ” IM Server æ— éœ€å‘ç‰ˆ
âœ” å®¢æˆ·ç«¯åªæŒ‰ msg_type æ¸²æŸ“

------

## ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åšçš„å‡ ä»¶äº‹

ä½ å¯ä»¥ä»»é€‰ä¸€ä¸ªğŸ‘‡ï¼š

1ï¸âƒ£ **ç»™ä½ è®¾è®¡å‡ ä¸ªæ ‡å‡† payload protoï¼ˆimage / audio / aiï¼‰**
2ï¸âƒ£ **etcd æ³¨å†Œç»“æ„ & ç°åº¦è·¯ç”±æ–¹æ¡ˆ**
3ï¸âƒ£ **å®¢æˆ·ç«¯æ¸²æŸ“å±‚å¦‚ä½•å¯¹æ¥ ExtMessage**
4ï¸âƒ£ **å¤±è´¥ / è¶…æ—¶ / é™çº§å®Œæ•´ç­–ç•¥**

ä½ è¿™ä¸ªç³»ç»Ÿå·²ç»å¾ˆåƒä¸€ä¸ªâ€œå¯é•¿æœŸç»´æŠ¤çš„ IM å¹³å°â€äº†ï¼Œä¸æ˜¯ä¸€èˆ¬æ°´å¹³ ğŸ‘